<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Group Schedule Viewer</title>

  <!-- FullCalendar CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
    rel="stylesheet"
  >

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h1 {
      text-align: center;
    }

    #controls {
      text-align: center;
      margin-bottom: 20px;
    }

    #calendar {
      max-width: 1000px;
      margin: 0 auto;
    }
  </style>
</head>

<body>

  <h1>Group Schedule Viewer</h1>

  <div id="controls">
    <input type="file" id="csvFile" accept=".csv">
    <button id="uploadBtn">Upload CSV</button>
    <button id="resetBtn">Reset</button>
  </div>

  <div id="calendar"></div>

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    let calendar;

    // ----------------------------
    // Initialize calendar
    // ----------------------------
    document.addEventListener("DOMContentLoaded", function () {
      const calendarEl = document.getElementById("calendar");

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "timeGridWeek",
        allDaySlot: false,
        slotMinTime: "08:00:00",
        slotMaxTime: "20:00:00",
        height: "auto"
      });

      calendar.render();
      fetchCalendar();

      // Button listeners
      document.getElementById("uploadBtn").addEventListener("click", uploadCSV);
      document.getElementById("resetBtn").addEventListener("click", resetSchedules);
    });

    // ----------------------------
    // Upload CSV
    // ----------------------------
    async function uploadCSV() {
      const fileInput = document.getElementById("csvFile");

      if (!fileInput.files.length) {
        alert("Please select a CSV file.");
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      await fetch("/upload", {
        method: "POST",
        body: formData
      });

      fetchCalendar();
    }

    // ----------------------------
    // Fetch calendar data
    // ----------------------------
    async function fetchCalendar() {
      const res = await fetch("/calendar");
      const data = await res.json();

      calendar.removeAllEvents();

      if (data.message) return;

      for (const [day, events] of Object.entries(data.busy)) {
        events.forEach(([start, end, count]) => {
          calendar.addEvent({
            title: `Busy (${count})`,
            start: `${getNextWeekdayDate(day)}T${start}`,
            end: `${getNextWeekdayDate(day)}T${end}`,
            backgroundColor: overlapColor(count),
            borderColor: overlapColor(count)
          });
        });
      }
    }

    // ----------------------------
    // Reset schedules
    // ----------------------------
    async function resetSchedules() {
      await fetch("/reset", { method: "POST" });
      calendar.removeAllEvents();
    }

    // ----------------------------
    // Helpers
    // ----------------------------
    function minutesToHHMM(minutes) {
      const h = Math.floor(minutes / 60).toString().padStart(2, "0");
      const m = (minutes % 60).toString().padStart(2, "0");
      return `${h}:${m}`;
    }

    function getNextWeekdayDate(weekday) {
      const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
      const today = new Date();
      let diff = (days.indexOf(weekday) + 7 - today.getDay()) % 7;
      if (diff === 0) diff = 7;
      today.setDate(today.getDate() + diff);
      return today.toISOString().split("T")[0];
    }

    function overlapColor(count) {
      const capped = Math.min(count, 5);
      const factor = 1 - (capped - 1) * 0.1; // 10% darker per additional overlap
      const r = Math.floor(255 * factor);
      const g = Math.floor(77 * factor);
      const b = Math.floor(77 * factor);
      return `rgb(${r}, ${g}, ${b})`;
    }

  </script>

</body>
</html>

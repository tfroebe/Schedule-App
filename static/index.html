<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Group Schedule Viewer</title>

  <!-- FullCalendar CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
    rel="stylesheet"
  >

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h1 {
      text-align: center;
    }

    #controls {
      text-align: center;
      margin-bottom: 20px;
    }

    #userToggles {
      text-align: center;
      margin-bottom: 20px;
    }

    #calendar {
      max-width: 1000px;
      margin: 0 auto;
    }
  </style>
</head>

<body>

<h1>Group Schedule Viewer</h1>

<div id="controls">
  <input type="text" id="usernameInput" placeholder="Your name">
  <input type="file" id="csvFile" accept=".csv">
  <button id="uploadBtn">Upload CSV</button>
  <button id="resetBtn">Reset</button>
</div>

<div id="userToggles"></div>
<div id="calendar"></div>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
  let calendar;
  let activeUsers = new Set();  // IDs of users whose events are visible
  let userList = [];            // [{user_id, username}]

  const SEMESTER_START = "2026-01-19"; // Monday
  const DAY_INDEX = {
    Sunday: 0,
    Monday: 1,
    Tuesday: 2,
    Wednesday: 3,
    Thursday: 4,
    Friday: 5,
    Saturday: 6
  };

  document.addEventListener("DOMContentLoaded", function () {
    const calendarEl = document.getElementById("calendar");

    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "timeGridWeek",
      initialDate: SEMESTER_START,
      allDaySlot: false,
      slotMinTime: "08:00:00",
      slotMaxTime: "20:00:00",
      height: "auto",

      headerToolbar: {
        left: "prev,next",
        center: "title",
        right: ""
      },

      datesSet: fetchCalendar
    });

    calendar.render();

    document.getElementById("uploadBtn").addEventListener("click", uploadCSV);
    document.getElementById("resetBtn").addEventListener("click", resetSchedules);
  });

  async function uploadCSV() {
    const fileInput = document.getElementById("csvFile");
    const usernameInput = document.getElementById("usernameInput");
    const username = usernameInput.value || `User ${Date.now()}`;

    if (!fileInput.files.length) {
      alert("Please select a CSV file.");
      return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    formData.append("username", username);

    const res = await fetch("/upload", {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    // Track new user
    const userObj = { user_id: data.user_id, username: data.username };
    userList.push(userObj);
    activeUsers.add(data.user_id);

    renderUserToggles();
    fetchCalendar();
  }

  function renderUserToggles() {
    const container = document.getElementById("userToggles");
    container.innerHTML = "";

    userList.forEach(user => {
      const label = document.createElement("label");
      label.style.marginRight = "10px";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = activeUsers.has(user.user_id);
      checkbox.onchange = () => {
        if (checkbox.checked) {
          activeUsers.add(user.user_id);
        } else {
          activeUsers.delete(user.user_id);
        }
        fetchCalendar(); // re-render calendar
      };

      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(` ${user.username}`));
      container.appendChild(label);
    });
  }

  async function fetchCalendar() {
    const res = await fetch("/calendar");
    const data = await res.json();

    calendar.removeAllEvents();
    if (data.message) return;

    const weekStart = calendar.view.currentStart;

    for (const [day, events] of Object.entries(data.busy)) {
      events.forEach(([start, end, count, user_id]) => {
        if (!activeUsers.has(user_id)) return;

        calendar.addEvent({
          title: `Busy (${count})`,
          start: `${getDateForWeekday(weekStart, day)}T${start}`,
          end: `${getDateForWeekday(weekStart, day)}T${end}`,
          backgroundColor: overlapColor(count),
          borderColor: overlapColor(count)
        });
      });
    }
  }

  async function resetSchedules() {
    await fetch("/reset", { method: "POST" });
    calendar.removeAllEvents();
    userList = [];
    activeUsers.clear();
    renderUserToggles();
  }

  function getDateForWeekday(weekStart, weekday) {
    const date = new Date(weekStart);
    const diff = DAY_INDEX[weekday] - date.getDay();
    date.setDate(date.getDate() + diff);
    return date.toISOString().split("T")[0];
  }

  function overlapColor(count) {
    const capped = Math.min(count, 5);
    const factor = 1 - (capped - 1) * 0.15;
    return `rgb(${Math.floor(255 * factor)}, ${Math.floor(77 * factor)}, ${Math.floor(77 * factor)})`;
  }
</script>

</body>
</html>
